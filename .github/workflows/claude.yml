name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º dev-–≤–µ—Ç–∫—É –∏–∑ –ª–µ–π–±–ª–∞ issue
      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
            } else if (context.payload.pull_request) {
              labels = context.payload.pull_request.labels.map(l => l.name);
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            console.log(`Developer: ${devName || '(none)'}`);
            console.log(`Target branch: ${branch || 'main (default)'}`);

      # 2. Checkout main (–Ω—É–∂–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è dev-–≤–µ—Ç–∫–∏ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. –°–æ–∑–¥–∞—ë–º dev-–≤–µ—Ç–∫—É –∏–∑ main –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
      - name: Ensure dev branch exists
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "‚úÖ Branch $BRANCH already exists"
          else
            echo "üå± Creating $BRANCH from main"
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
            echo "‚úÖ Branch $BRANCH created"
          fi

      # 4. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ dev-–≤–µ—Ç–∫—É ‚Äî Claude —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç –Ω–µ—ë
      - name: Switch to dev branch
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          git checkout "$BRANCH"
          git pull origin "$BRANCH"
          echo "üìÇ Working from branch: $(git branch --show-current)"
          echo "üìù Last commit: $(git log --oneline -1)"

      # 5. Claude Code –¥–µ–ª–∞–µ—Ç —Ä–∞–±–æ—Ç—É
      #    –°–æ–∑–¥–∞—ë—Ç —Å–≤–æ—é –≤–µ—Ç–∫—É –æ—Ç —Ç–µ–∫—É—â–µ–π (dev/X) –∏ –æ—Ç–∫—Ä–æ–µ—Ç PR
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 30

      # 6. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º PR Claude –≤ dev-–≤–µ—Ç–∫—É –∏ –º–µ—Ä–∂–∏–º
      - name: Merge Claude PR into dev branch
        if: steps.dev.outputs.branch != ''
        uses: actions/github-script@v7
        with:
          script: |
            const devBranch = '${{ steps.dev.outputs.branch }}';
            const issueNum = context.payload.issue?.number;

            if (!issueNum) {
              console.log('No issue number, skipping');
              return;
            }

            // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ PR
            await new Promise(r => setTimeout(r, 5000));

            // –ò—â–µ–º PR –æ—Ç Claude –¥–ª—è —ç—Ç–æ–≥–æ issue
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 20
            });

            const claudePr = prs.find(pr =>
              pr.head.ref.includes(`issue-${issueNum}`) ||
              pr.body?.includes(`#${issueNum}`)
            );

            if (!claudePr) {
              console.log(`‚ö†Ô∏è No open PR found for issue #${issueNum}`);
              return;
            }

            console.log(`Found PR #${claudePr.number}: ${claudePr.title}`);
            console.log(`  ${claudePr.head.ref} ‚Üí ${claudePr.base.ref}`);

            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º PR –Ω–∞ dev-–≤–µ—Ç–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (claudePr.base.ref !== devBranch) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: claudePr.number,
                base: devBranch
              });
              console.log(`‚úÖ Retargeted ‚Üí ${devBranch}`);
            }

            // –ú–µ—Ä–∂–∏–º –≤ dev-–≤–µ—Ç–∫—É
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: claudePr.number,
                merge_method: 'squash',
                commit_title: `${claudePr.title} (#${claudePr.number})`
              });
              console.log(`‚úÖ Merged into ${devBranch}`);

              // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –≤–µ—Ç–∫—É Claude
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${claudePr.head.ref}`
              });
              console.log(`üóëÔ∏è Deleted branch ${claudePr.head.ref}`);
            } catch (err) {
              console.log(`‚ùå Error: ${err.message}`);
            }
