name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º dev-–≤–µ—Ç–∫—É –∏–∑ –ª–µ–π–±–ª–∞
      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            let issueTitle = '';
            let issueNumber = '';
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
              issueTitle = context.payload.issue.title;
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              labels = context.payload.pull_request.labels.map(l => l.name);
              issueTitle = context.payload.pull_request.title;
              issueNumber = context.payload.pull_request.number;
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_number', String(issueNumber));
            console.log(`Developer: ${devName || '(none)'}`);
            console.log(`Target branch: ${branch || 'main (default)'}`);

      # 2. Checkout
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. –°–æ–∑–¥–∞—ë–º dev-–≤–µ—Ç–∫—É –∏–∑ main –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
      - name: Ensure dev branch exists
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "‚úÖ Branch $BRANCH already exists"
          else
            echo "üå± Creating $BRANCH from main"
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
            echo "‚úÖ Branch $BRANCH created"
          fi

      # 4. üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Claude –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É
      - name: Notify ‚Äî Claude started
        if: steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_started\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # ============ OPUS: –ø–æ–ø—ã—Ç–∫–∞ 1 ============
      - name: "Claude Code ‚Äî Opus (attempt 1)"
        id: opus1
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          trigger_phrase: "@@DISABLED@@"
          prompt: |
            Read GitHub issue #${{ github.event.issue.number }} in this repository and implement the requested changes.
            Issue title: ${{ github.event.issue.title }}
            Use `gh issue view ${{ github.event.issue.number }}` to read the full issue details if needed.
            Follow CLAUDE.md if it exists in the repo root.
            After implementing all changes, commit with a descriptive message and push to your current branch.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          base_branch: ${{ steps.dev.outputs.branch || '' }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 30

      # –ß–∏—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É –µ—Å–ª–∏ Opus 1 —É–ø–∞–ª (–∏–Ω–∞—á–µ retry –Ω–µ —Å–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É)
      - name: Cleanup after Opus 1
        if: steps.opus1.outcome == 'failure'
        run: |
          echo "Cleaning up branches after failed attempt..."
          git checkout "${{ steps.dev.outputs.branch || 'main' }}" 2>/dev/null || git checkout main
          for b in $(git branch --list 'claude/issue-*'); do
            git branch -D "$b" 2>/dev/null || true
          done
          echo "‚úÖ Cleanup done"

      # ============ OPUS: –ø–æ–ø—ã—Ç–∫–∞ 2 ============
      - name: "Claude Code ‚Äî Opus (attempt 2)"
        id: opus2
        if: steps.opus1.outcome == 'failure'
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          trigger_phrase: "@@DISABLED@@"
          prompt: |
            Read GitHub issue #${{ github.event.issue.number }} in this repository and implement the requested changes.
            Issue title: ${{ github.event.issue.title }}
            Use `gh issue view ${{ github.event.issue.number }}` to read the full issue details if needed.
            Follow CLAUDE.md if it exists in the repo root.
            After implementing all changes, commit with a descriptive message and push to your current branch.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          base_branch: ${{ steps.dev.outputs.branch || '' }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 30

      # –ß–∏—Å—Ç–∏–º –ø–µ—Ä–µ–¥ Sonnet
      - name: Cleanup after Opus 2
        if: steps.opus1.outcome == 'failure' && steps.opus2.outcome == 'failure'
        run: |
          echo "Cleaning up branches after failed attempt..."
          git checkout "${{ steps.dev.outputs.branch || 'main' }}" 2>/dev/null || git checkout main
          for b in $(git branch --list 'claude/issue-*'); do
            git branch -D "$b" 2>/dev/null || true
          done
          echo "‚úÖ Cleanup done"

      # ============ SONNET: fallback ============
      - name: Notify ‚Äî switching to Sonnet
        id: sonnet_notify
        if: steps.opus1.outcome == 'failure' && steps.opus2.outcome == 'failure' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          echo "Both Opus attempts failed, falling back to Sonnet"
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"opus_unavailable\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: "Claude Code ‚Äî Sonnet (fallback)"
        id: sonnet
        if: steps.opus1.outcome == 'failure' && steps.opus2.outcome == 'failure'
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          trigger_phrase: "@@DISABLED@@"
          prompt: |
            Read GitHub issue #${{ github.event.issue.number }} in this repository and implement the requested changes.
            Issue title: ${{ github.event.issue.title }}
            Use `gh issue view ${{ github.event.issue.number }}` to read the full issue details if needed.
            Follow CLAUDE.md if it exists in the repo root.
            After implementing all changes, commit with a descriptive message and push to your current branch.
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          base_branch: ${{ steps.dev.outputs.branch || '' }}
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 30

      # ============ FAIL: –≤—Å–µ 3 –ø–æ–ø—ã—Ç–∫–∏ ============
      - name: Notify ‚Äî all attempts failed
        if: |
          steps.opus1.outcome == 'failure' &&
          steps.opus2.outcome == 'failure' &&
          steps.sonnet.outcome == 'failure' &&
          steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          echo "All 3 attempts failed (2x Opus + 1x Sonnet)"
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_failed\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # ============ MERGE ============
      - name: Check if any attempt succeeded
        id: check
        run: |
          if [[ "${{ steps.opus1.outcome }}" == "success" ]] || \
             [[ "${{ steps.opus2.outcome }}" == "success" ]] || \
             [[ "${{ steps.sonnet.outcome }}" == "success" ]]; then
            echo "claude_ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "claude_ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Auto-merge into dev branch
        id: merge
        if: steps.dev.outputs.branch != '' && steps.check.outputs.claude_ok == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const devBranch = '${{ steps.dev.outputs.branch }}';
            const issueNum = context.payload.issue?.number;

            if (!issueNum) {
              console.log('No issue number, skipping');
              return;
            }

            // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π action
            await new Promise(r => setTimeout(r, 10000));

            // –ò—â–µ–º –≤–µ—Ç–∫—É Claude –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É
            const { data: refs } = await github.rest.git.listMatchingRefs({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/claude/issue-${issueNum}`
            });

            if (refs.length === 0) {
              console.log(`‚ö†Ô∏è No claude branch found for issue #${issueNum}`);
              return;
            }

            const claudeRef = refs[refs.length - 1];
            const claudeBranch = claudeRef.ref.replace('refs/heads/', '');
            console.log(`Found Claude branch: ${claudeBranch}`);

            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${claudeBranch}`,
              state: 'open'
            });

            let pr = prs[0];

            // –ï—Å–ª–∏ PR –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º —Å–∞–º–∏
            if (!pr) {
              console.log(`No PR found, creating one: ${claudeBranch} ‚Üí ${devBranch}`);
              const { data: newPr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: claudeBranch,
                base: devBranch,
                title: `Auto-merge: issue #${issueNum}`,
                body: `Automatic merge of Claude's work into \`${devBranch}\`.\n\nCloses #${issueNum}`
              });
              pr = newPr;
              console.log(`‚úÖ Created PR #${pr.number}`);
            } else {
              console.log(`Found existing PR #${pr.number}: ${pr.head.ref} ‚Üí ${pr.base.ref}`);
              if (pr.base.ref !== devBranch) {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  base: devBranch
                });
                console.log(`‚úÖ Retargeted PR #${pr.number} ‚Üí ${devBranch}`);
              }
            }

            // –ú–µ—Ä–∂–∏–º (—Å retry)
            let merged = false;
            for (let attempt = 1; attempt <= 5; attempt++) {
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: `${pr.title} (#${pr.number})`
                });
                console.log(`‚úÖ Merged PR #${pr.number} into ${devBranch} (attempt ${attempt})`);
                merged = true;
                break;
              } catch (err) {
                console.log(`‚ö†Ô∏è Merge attempt ${attempt}/5 failed: ${err.message}`);
                if (attempt < 5) {
                  await new Promise(r => setTimeout(r, 3000 * attempt));
                }
              }
            }

            if (!merged) {
              console.log(`‚ùå All merge attempts failed for PR #${pr.number}`);
              core.setOutput('merged', 'false');
              return;
            }

            core.setOutput('merged', 'true');

            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –≤–µ—Ç–∫—É Claude
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${claudeBranch}`
              });
              console.log(`üóëÔ∏è Deleted branch ${claudeBranch}`);
            } catch (err) {
              console.log(`‚ö†Ô∏è Could not delete branch: ${err.message}`);
            }

      # üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: –ø—É—à –≤ dev-–≤–µ—Ç–∫—É
      - name: Notify ‚Äî merged to dev
        if: steps.dev.outputs.branch != '' && steps.merge.outputs.merged == 'true'
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"merged\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"
