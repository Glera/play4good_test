name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ç–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏–∑ –ª–µ–π–±–ª–∞ issue
      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
            } else if (context.payload.pull_request) {
              labels = context.payload.pull_request.labels.map(l => l.name);
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            console.log(`Developer: ${devName || '(none)'}`);
            console.log(`Target branch: ${branch || '(repo default)'}`);

      # 2. Checkout —Ä–µ–ø–æ (–≤—Å–µ –≤–µ—Ç–∫–∏)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. –°–æ–∑–¥–∞—ë–º dev-–≤–µ—Ç–∫—É –∏–∑ main, –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
      - name: Ensure dev branch exists
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "‚úÖ Branch $BRANCH already exists"
          else
            echo "üå± Creating $BRANCH from main"
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
            echo "‚úÖ Branch $BRANCH created"
          fi

      # 4. Claude Code —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç dev-–≤–µ—Ç–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
      #    PR –±—É–¥–µ—Ç –Ω–∞—Ü–µ–ª–µ–Ω –Ω–∞ dev/X, –∞ –Ω–µ –Ω–∞ main
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          base_branch: ${{ steps.dev.outputs.branch }}
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 30
