name: Claude Code

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º dev-–≤–µ—Ç–∫—É –∏–∑ –ª–µ–π–±–ª–∞
      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            let issueTitle = '';
            let issueNumber = '';
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
              issueTitle = context.payload.issue.title;
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              labels = context.payload.pull_request.labels.map(l => l.name);
              issueTitle = context.payload.pull_request.title;
              issueNumber = context.payload.pull_request.number;
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_number', String(issueNumber));
            console.log(`Developer: ${devName || '(none)'}`);
            console.log(`Target branch: ${branch || 'main (default)'}`);

      # 2. Checkout –Ω–∞ dev-–≤–µ—Ç–∫—É
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.dev.outputs.branch || 'main' }}

      # 3. –°–æ–∑–¥–∞—ë–º dev-–≤–µ—Ç–∫—É –∏–∑ main –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
      - name: Ensure dev branch exists
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "‚úÖ Branch $BRANCH already exists"
          else
            echo "üå± Creating $BRANCH from main"
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
            echo "‚úÖ Branch $BRANCH created"
          fi

      # 4. üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: Claude –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É
      - name: Notify ‚Äî Claude started
        if: steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_started\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git + auth –¥–ª—è push
      - name: Configure git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

          # –í—à–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –≤ remote URL —á—Ç–æ–±—ã Claude CLI –º–æ–≥ –ø—É—à–∏—Ç—å
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ push —Ä–∞–±–æ—Ç–∞–µ—Ç
          echo "‚úÖ Git configured with push access"
          git remote -v

      # 6. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º SHA –¥–æ —Ä–∞–±–æ—Ç—ã Claude
      - name: Save initial commit SHA
        run: |
          echo "INITIAL_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"

      # 7. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Claude Code CLI
      - name: Install Claude Code CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "‚úÖ Claude Code CLI installed"
          $HOME/.local/bin/claude --version

      # 8. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ notify.sh –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ Claude ‚Üí Telegram
      - name: Setup Claude notifications
        run: |
          if [ -f "./notify.sh" ]; then
            # Fix Windows line endings if present
            sed -i 's/\r$//' ./notify.sh
            chmod +x ./notify.sh
            echo "‚úÖ notify.sh ready"
          else
            echo "‚ö†Ô∏è notify.sh not found ‚Äî Claude won't be able to send messages"
          fi

      # 9. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–ª–∞–Ω –≤ Telegram –î–û –∑–∞–ø—É—Å–∫–∞ Claude
      - name: Notify ‚Äî Claude starting task
        continue-on-error: true
        env:
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          echo "DEBUG: BOT_NOTIFY_URL is set: $( [ -n \"$BOT_NOTIFY_URL\" ] && echo 'yes' || echo 'no' )"
          echo "DEBUG: ISSUE_NUMBER=$ISSUE_NUMBER"
          echo "DEBUG: GITHUB_HEAD_REF=$GITHUB_HEAD_REF"
          if [ -f "./notify.sh" ]; then
            echo "DEBUG: notify.sh exists, calling it..."
            ./notify.sh info "Claude –ø—Ä–∏—Å—Ç—É–ø–∞–µ—Ç –∫ –∑–∞–¥–∞—á–µ: ${{ steps.dev.outputs.issue_title }}"
            echo "DEBUG: notify.sh exit code: $?"
          else
            echo "DEBUG: notify.sh NOT FOUND"
          fi

      # 10. –ì–æ—Ç–æ–≤–∏–º –ø—Ä–æ–º–ø—Ç –∏–∑ issue
      - name: Prepare prompt
        id: prompt
        shell: bash
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE=$(echo "${{ steps.dev.outputs.issue_title }}" | sed 's/"/\\"/g')
          BRANCH=$(git branch --show-current)

          cat > /tmp/claude-prompt.txt << PROMPT_EOF
          You are working in a GitHub repository checkout on branch "${BRANCH}".

          TASK: Implement changes for Issue #${ISSUE_NUM}: "${ISSUE_TITLE}"

          ‚ö†Ô∏è MANDATORY FIRST STEP ‚Äî BEFORE ANYTHING ELSE, RUN THIS COMMAND:
          ./notify.sh plan "Your 1-2 sentence plan describing what you will change"

          This sends a message to the developer in Telegram. You MUST do this first.

          WORKFLOW:
          1. Run: ./notify.sh plan "Your plan here"
          2. Read CLAUDE.md ‚Äî it contains project rules and DEVLOG instructions
          3. Look at relevant source files  
          4. Implement the changes
          5. git add -A && git commit -m "feat: ${ISSUE_TITLE} (#${ISSUE_NUM})"
          6. Get commit SHA: COMMIT_SHA=\$(git rev-parse HEAD)
          7. Add entry to DEVLOG.md (at the top, after header) with: issue number, title, date, branch, commit SHA, what was done, changed files, cherry-pick command
          8. git add DEVLOG.md && git commit --amend --no-edit
          9. git push origin ${BRANCH}

          DEVLOG ENTRY FORMAT (add to top of DEVLOG.md):
          ## #${ISSUE_NUM} ‚Äî ${ISSUE_TITLE}
          **–î–∞—Ç–∞:** $(date +%Y-%m-%d)
          **–í–µ—Ç–∫–∞:** ${BRANCH}
          **–ö–æ–º–º–∏—Ç:** \`<short-sha>\`
          **–°—Ç–∞—Ç—É—Å:** ‚úÖ –≥–æ—Ç–æ–≤–æ –∫ –ø–µ—Ä–µ–Ω–æ—Å—É

          ### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ
          <description>

          ### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          - \`file.js\` ‚Äî what changed

          ### –ö–∞–∫ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ main
          git cherry-pick <full-sha>

          ---

          COMMUNICATION (use ./notify.sh anytime):
          - ./notify.sh plan "..." ‚Äî your plan (REQUIRED at start)
          - ./notify.sh progress "..." ‚Äî progress update
          - ./notify.sh error "..." ‚Äî if you find a problem

          RULES:
          - Stay on branch ${BRANCH}, do NOT create new branches
          - Make clean, focused changes
          - ALWAYS update DEVLOG.md before pushing
          - Once pushed, you are DONE ‚Äî do not loop
          PROMPT_EOF

          echo "‚úÖ Prompt ready for issue #${ISSUE_NUM} on branch ${BRANCH}"
          cat /tmp/claude-prompt.txt

      # ============================================================
      # OPUS: –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ (50 —Ç—ë—Ä–Ω–æ–≤)
      # ============================================================
      - name: "Claude Code ‚Äî Opus"
        id: opus1
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          set +e
          # Export vars for notify.sh called by Claude
          export ISSUE_NUMBER="${{ steps.dev.outputs.issue_number }}"
          export BOT_NOTIFY_URL="${{ secrets.BOT_WEBHOOK_URL }}"
          export GITHUB_HEAD_REF="${{ steps.dev.outputs.branch }}"
          
          echo "üß† Running Claude Code (Opus)..."
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)" 2>&1 | tee /tmp/claude-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          # CLI –≤—ã—Ö–æ–¥–∏—Ç —Å –∫–æ–¥–æ–º 0 –¥–∞–∂–µ –ø—Ä–∏ max turns ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ñ–µ–π–ª–∏–º
          if grep -qi "Reached max turns\|max.turns" /tmp/claude-output.txt; then
            echo "OPUS_MAX_TURNS=true" >> "$GITHUB_ENV"
            echo "‚è≥ Hit max turns ‚Äî will continue session"
            exit 1
          fi
          exit $EXIT_CODE

      # ============================================================
      # OPUS: –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ —É–ª–æ–∂–∏–ª—Å—è –≤ —Ç—ë—Ä–Ω—ã (+30)
      # ============================================================
      - name: "Claude Code ‚Äî Opus continue (+30 turns)"
        id: opus_cont1
        if: steps.opus1.outcome == 'failure' && env.OPUS_MAX_TURNS == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          set +e
          echo "üîÑ Continuing Opus session (+30 turns)..."
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --continue \
            --max-turns 30 \
            --verbose 2>&1 | tee /tmp/claude-output2.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "Reached max turns\|max.turns" /tmp/claude-output2.txt; then
            echo "OPUS_MAX_TURNS_2=true" >> "$GITHUB_ENV"
            echo "‚è≥ Still hitting max turns ‚Äî one more continue"
            exit 1
          fi
          exit $EXIT_CODE

      # ============================================================
      # OPUS: –µ—â—ë –æ–¥–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ (+30, –∏—Ç–æ–≥–æ –¥–æ 110)
      # ============================================================
      - name: "Claude Code ‚Äî Opus continue 2 (+30 turns)"
        id: opus_cont2
        if: steps.opus_cont1.outcome == 'failure' && env.OPUS_MAX_TURNS_2 == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          echo "üîÑ Continuing Opus session (final +30 turns, total 110)..."
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --continue \
            --max-turns 30 \
            --verbose

      # ============================================================
      # –û–ø—Ä–µ–¥–µ–ª—è–µ–º: Opus —É—Å–ø–µ—à–µ–Ω?
      # ============================================================
      - name: Check Opus result
        id: opus_result
        run: |
          if [[ "${{ steps.opus1.outcome }}" == "success" ]] || \
             [[ "${{ steps.opus_cont1.outcome }}" == "success" ]] || \
             [[ "${{ steps.opus_cont2.outcome }}" == "success" ]]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      # ============================================================
      # OPUS: retry (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–µ, –ù–ï max turns)
      # ============================================================
      - name: Reset after Opus real error
        if: steps.opus_result.outputs.ok == 'false' && env.OPUS_MAX_TURNS != 'true'
        run: |
          echo "üßπ Real error ‚Äî resetting for retry..."
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: "Claude Code ‚Äî Opus (retry after error)"
        id: opus_retry
        if: steps.opus_result.outputs.ok == 'false' && env.OPUS_MAX_TURNS != 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          echo "üß† Retrying Claude Code (Opus)..."
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)"

      # ============================================================
      # SONNET: fallback (–µ—Å–ª–∏ Opus –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è)
      # ============================================================
      - name: Check if need Sonnet
        id: need_sonnet
        run: |
          OPUS_OK="false"
          if [[ "${{ steps.opus_result.outputs.ok }}" == "true" ]] || \
             [[ "${{ steps.opus_retry.outcome }}" == "success" ]]; then
            OPUS_OK="true"
          fi
          echo "opus_ok=$OPUS_OK" >> "$GITHUB_OUTPUT"

      - name: Reset for Sonnet
        if: steps.need_sonnet.outputs.opus_ok == 'false'
        run: |
          echo "üßπ Resetting for Sonnet fallback..."
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: Notify ‚Äî switching to Sonnet
        if: steps.need_sonnet.outputs.opus_ok == 'false' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"opus_unavailable\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: "Claude Code ‚Äî Sonnet (fallback)"
        id: sonnet
        if: steps.need_sonnet.outputs.opus_ok == 'false'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          set +e
          echo "üß† Running Claude Code (Sonnet, fallback)..."
          claude -p --dangerously-skip-permissions \
            --model claude-sonnet-4-5-20250929 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)" 2>&1 | tee /tmp/claude-sonnet.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "Reached max turns\|max.turns" /tmp/claude-sonnet.txt; then
            echo "SONNET_MAX_TURNS=true" >> "$GITHUB_ENV"
            exit 1
          fi
          exit $EXIT_CODE

      - name: "Claude Code ‚Äî Sonnet continue (+30 turns)"
        id: sonnet_cont
        if: steps.sonnet.outcome == 'failure' && env.SONNET_MAX_TURNS == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          echo "üîÑ Continuing Sonnet session (+30 turns)..."
          claude -p --dangerously-skip-permissions \
            --model claude-sonnet-4-5-20250929 \
            --continue \
            --max-turns 30 \
            --verbose

      # ============================================================
      # –§–ò–ù–ê–õ: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π git push (–Ω–µ –≤–µ—Ä–∏–º exit code!)
      # ============================================================
      - name: Verify actual push
        id: verify
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Initial SHA: $INITIAL_SHA"
          echo "Current SHA: $CURRENT_SHA"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã
          if [[ "$CURRENT_SHA" != "$INITIAL_SHA" ]]; then
            echo "‚úÖ New local commits detected!"
            git log --oneline "$INITIAL_SHA"..HEAD
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          else
            # –ú–æ–∂–µ—Ç Claude –∑–∞–ø—É—à–∏–ª –Ω–∞–ø—Ä—è–º—É—é ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º remote
            git fetch origin
            BRANCH=$(git branch --show-current)
            REMOTE_SHA=$(git rev-parse "origin/$BRANCH" 2>/dev/null || echo "none")
            if [[ "$REMOTE_SHA" != "$INITIAL_SHA" ]] && [[ "$REMOTE_SHA" != "none" ]]; then
              echo "‚úÖ Remote has new commits!"
              echo "pushed=true" >> "$GITHUB_OUTPUT"
            else
              echo "‚ùå No new commits ‚Äî Claude didn't push anything"
              echo "pushed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ============================================================
      # –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ push!)
      # ============================================================
      - name: Notify ‚Äî all attempts failed
        if: steps.verify.outputs.pushed == 'false' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_failed\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: Notify ‚Äî changes pushed
        if: steps.verify.outputs.pushed == 'true' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"merged\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: Close issue
        if: steps.verify.outputs.pushed == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = context.payload.issue?.number;
            if (issueNum) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                state: 'closed'
              });
              console.log(`‚úÖ Closed issue #${issueNum}`);
            }
