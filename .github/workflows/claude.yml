name: Claude Code

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ dev-Ð²ÐµÑ‚ÐºÑƒ Ð¸Ð· Ð»ÐµÐ¹Ð±Ð»Ð°
      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            let issueTitle = '';
            let issueNumber = '';
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
              issueTitle = context.payload.issue.title;
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              labels = context.payload.pull_request.labels.map(l => l.name);
              issueTitle = context.payload.pull_request.title;
              issueNumber = context.payload.pull_request.number;
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_number', String(issueNumber));
            console.log(`Developer: ${devName || '(none)'}`);
            console.log(`Target branch: ${branch || 'main (default)'}`);

      # 2. Checkout Ð½Ð° dev-Ð²ÐµÑ‚ÐºÑƒ
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.dev.outputs.branch || 'main' }}

      # 3. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ dev-Ð²ÐµÑ‚ÐºÑƒ Ð¸Ð· main ÐµÑÐ»Ð¸ ÐµÑ‘ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
      - name: Ensure dev branch exists
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "âœ… Branch $BRANCH already exists"
          else
            echo "ðŸŒ± Creating $BRANCH from main"
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
            echo "âœ… Branch $BRANCH created"
          fi

      # 4. ðŸ”” Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ: Claude Ð½Ð°Ñ‡Ð°Ð» Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ
      - name: Notify â€” Claude started
        if: steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_started\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # 5. ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git
      - name: Configure git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      # 6. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Claude Code CLI (Ð¼Ð¸Ð½ÑƒÑ ÑÐ»Ð¾Ð¼Ð°Ð½Ð½Ñ‹Ð¹ SDK)
      - name: Install Claude Code CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "âœ… Claude Code CLI installed"
          $HOME/.local/bin/claude --version

      # 7. Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð¸Ð· issue
      - name: Prepare prompt
        id: prompt
        shell: bash
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE=$(echo "${{ steps.dev.outputs.issue_title }}" | sed 's/"/\\"/g')
          BRANCH=$(git branch --show-current)

          cat > /tmp/claude-prompt.txt << EOF
          You are working in a GitHub repository checkout on branch "${BRANCH}".

          TASK: Implement changes for Issue #${ISSUE_NUM}: "${ISSUE_TITLE}"

          Steps:
          1. Read CLAUDE.md in repo root if it exists
          2. Look at relevant source files
          3. Implement the requested changes
          4. Stage all changes: git add -A
          5. Commit: git commit -m "feat: ${ISSUE_TITLE} (#${ISSUE_NUM})"
          6. Push: git push origin ${BRANCH}

          Rules:
          - Stay on current branch (${BRANCH}), do NOT create new branches
          - Make clean, focused changes
          - Always commit and push when done
          EOF

          echo "âœ… Prompt ready for issue #${ISSUE_NUM} on branch ${BRANCH}"

      # ============================================================
      # OPUS: Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº (50 Ñ‚Ñ‘Ñ€Ð½Ð¾Ð²)
      # ============================================================
      - name: "Claude Code â€” Opus"
        id: opus1
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          set +e
          echo "ðŸ§  Running Claude Code (Opus)..."
          claude -p \
            --model claude-opus-4-5-20251101 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)" 2>&1 | tee /tmp/claude-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "max.turns\|max turns\|Reached max" /tmp/claude-output.txt; then
            echo "OPUS_MAX_TURNS=true" >> "$GITHUB_ENV"
            echo "â³ Hit max turns â€” will continue session"
          fi
          exit $EXIT_CODE

      # ============================================================
      # OPUS: Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐ»Ð¾Ð¶Ð¸Ð»ÑÑ Ð² Ñ‚Ñ‘Ñ€Ð½Ñ‹ (+30)
      # ============================================================
      - name: "Claude Code â€” Opus continue (+30 turns)"
        id: opus_cont1
        if: steps.opus1.outcome == 'failure' && env.OPUS_MAX_TURNS == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          set +e
          echo "ðŸ”„ Continuing Opus session (+30 turns)..."
          claude -p \
            --model claude-opus-4-5-20251101 \
            --continue \
            --max-turns 30 \
            --verbose 2>&1 | tee /tmp/claude-output2.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "max.turns\|max turns\|Reached max" /tmp/claude-output2.txt; then
            echo "OPUS_MAX_TURNS_2=true" >> "$GITHUB_ENV"
            echo "â³ Still hitting max turns â€” one more continue"
          fi
          exit $EXIT_CODE

      # ============================================================
      # OPUS: ÐµÑ‰Ñ‘ Ð¾Ð´Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð½Ðµ Ñ…Ð²Ð°Ñ‚Ð°ÐµÑ‚ (+30)
      # ============================================================
      - name: "Claude Code â€” Opus continue 2 (+30 turns)"
        id: opus_cont2
        if: steps.opus_cont1.outcome == 'failure' && env.OPUS_MAX_TURNS_2 == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ”„ Continuing Opus session (final +30 turns, total 110)..."
          claude -p \
            --model claude-opus-4-5-20251101 \
            --continue \
            --max-turns 30 \
            --verbose

      # ============================================================
      # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼: Opus ÑƒÑÐ¿ÐµÑˆÐµÐ½?
      # ============================================================
      - name: Check Opus result
        id: opus_result
        run: |
          if [[ "${{ steps.opus1.outcome }}" == "success" ]] || \
             [[ "${{ steps.opus_cont1.outcome }}" == "success" ]] || \
             [[ "${{ steps.opus_cont2.outcome }}" == "success" ]]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      # ============================================================
      # OPUS: retry (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ, Ð½Ðµ max turns)
      # ============================================================
      - name: Reset after Opus real error
        if: steps.opus_result.outputs.ok == 'false' && env.OPUS_MAX_TURNS != 'true'
        run: |
          echo "ðŸ§¹ Real error â€” resetting for retry..."
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: "Claude Code â€” Opus (retry after error)"
        id: opus_retry
        if: steps.opus_result.outputs.ok == 'false' && env.OPUS_MAX_TURNS != 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ§  Retrying Claude Code (Opus)..."
          claude -p \
            --model claude-opus-4-5-20251101 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)"

      # ============================================================
      # SONNET: fallback (ÐµÑÐ»Ð¸ Opus Ð½Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑÑ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ)
      # ============================================================
      - name: Check if need Sonnet
        id: need_sonnet
        run: |
          OPUS_OK="false"
          if [[ "${{ steps.opus_result.outputs.ok }}" == "true" ]] || \
             [[ "${{ steps.opus_retry.outcome }}" == "success" ]]; then
            OPUS_OK="true"
          fi
          echo "opus_ok=$OPUS_OK" >> "$GITHUB_OUTPUT"

      - name: Reset for Sonnet
        if: steps.need_sonnet.outputs.opus_ok == 'false'
        run: |
          echo "ðŸ§¹ Resetting for Sonnet fallback..."
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: Notify â€” switching to Sonnet
        if: steps.need_sonnet.outputs.opus_ok == 'false' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"opus_unavailable\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: "Claude Code â€” Sonnet (fallback)"
        id: sonnet
        if: steps.need_sonnet.outputs.opus_ok == 'false'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          set +e
          echo "ðŸ§  Running Claude Code (Sonnet, fallback)..."
          claude -p \
            --model claude-sonnet-4-5-20250929 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)" 2>&1 | tee /tmp/claude-sonnet.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "max.turns\|max turns\|Reached max" /tmp/claude-sonnet.txt; then
            echo "SONNET_MAX_TURNS=true" >> "$GITHUB_ENV"
          fi
          exit $EXIT_CODE

      - name: "Claude Code â€” Sonnet continue (+30 turns)"
        id: sonnet_cont
        if: steps.sonnet.outcome == 'failure' && env.SONNET_MAX_TURNS == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ”„ Continuing Sonnet session (+30 turns)..."
          claude -p \
            --model claude-sonnet-4-5-20250929 \
            --continue \
            --max-turns 30 \
            --verbose

      # ============================================================
      # Ð¤Ð˜ÐÐÐ›: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° + ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
      # ============================================================
      - name: Check final result
        id: check
        run: |
          if [[ "${{ steps.need_sonnet.outputs.opus_ok }}" == "true" ]] || \
             [[ "${{ steps.sonnet.outcome }}" == "success" ]] || \
             [[ "${{ steps.sonnet_cont.outcome }}" == "success" ]]; then
            echo "claude_ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "claude_ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify â€” all attempts failed
        if: steps.check.outputs.claude_ok == 'false' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_failed\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: Notify â€” changes pushed
        if: steps.dev.outputs.branch != '' && steps.check.outputs.claude_ok == 'true'
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"merged\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: Close issue
        if: steps.check.outputs.claude_ok == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = context.payload.issue?.number;
            if (issueNum) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                state: 'closed'
              });
              console.log(`âœ… Closed issue #${issueNum}`);
            }
