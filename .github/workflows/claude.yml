name: Claude Code (Multi-Agent)

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # ============================================================
      # SETUP: Branch detection, checkout, git config
      # ============================================================

      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            let issueTitle = '';
            let issueNumber = '';
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
              issueTitle = context.payload.issue.title;
              issueNumber = context.payload.issue.number;
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_number', String(issueNumber));

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.dev.outputs.branch || 'main' }}

      - name: Configure git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

      - name: Ensure dev branch exists and is up to date with main
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "Branch $BRANCH already exists — merging main into it"
            git merge origin/main --no-edit || {
              echo "Merge conflict — resetting to main"
              git merge --abort 2>/dev/null || true
              git reset --hard origin/main
            }
            git push origin "$BRANCH"
          else
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
          fi

      - name: Save initial commit SHA
        run: echo "INITIAL_SHA=$(git rev-parse HEAD)" >> "$GITHUB_ENV"

      - name: Install Claude Code CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          $HOME/.local/bin/claude --version

      - name: Setup tools
        run: |
          # notify.sh
          if [ -f "./notify.sh" ]; then
            sed -i 's/\r$//' ./notify.sh
            chmod +x ./notify.sh
          fi
          # codex-review.sh
          if [ -f "./codex-review.sh" ]; then
            sed -i 's/\r$//' ./codex-review.sh
            chmod +x ./codex-review.sh
          fi

      - name: Setup Node.js (for Playwright)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm ci
          npx playwright install chromium

      # ============================================================
      # NOTIFY: Claude started
      # ============================================================

      - name: "Notify: Claude started"
        if: steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_started\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # ============================================================
      # PHASE 1: PLAN (Claude writes a plan)
      # ============================================================

      - name: "Phase 1: Plan"
        id: plan
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ steps.dev.outputs.issue_title }}"
          BRANCH=$(git branch --show-current)

          cat > /tmp/plan-prompt.txt << 'PROMPT_EOF'
          You are working in a GitHub repository on branch "BRANCH_PLACEHOLDER".

          TASK: Create a detailed implementation plan for Issue #ISSUE_PLACEHOLDER: "TITLE_PLACEHOLDER"

          INSTRUCTIONS:
          1. Read CLAUDE.md for project rules
          2. Examine the codebase to understand the current state
          3. Write a concise implementation plan (10-30 lines) to /tmp/plan.md
          4. The plan should include:
             - What files will be changed/created
             - What specific changes will be made
             - Edge cases to consider
             - Testing approach
          5. Run: ./notify.sh plan "$(cat /tmp/plan.md | head -5)"

          IMPORTANT:
          - DO NOT make any code changes yet
          - DO NOT commit or push anything
          - ONLY write the plan to /tmp/plan.md and notify
          - Stay on the current branch
          PROMPT_EOF

          # Replace placeholders
          sed -i "s|BRANCH_PLACEHOLDER|$BRANCH|g" /tmp/plan-prompt.txt
          sed -i "s|ISSUE_PLACEHOLDER|$ISSUE_NUM|g" /tmp/plan-prompt.txt
          sed -i "s|TITLE_PLACEHOLDER|$ISSUE_TITLE|g" /tmp/plan-prompt.txt

          echo "=== Phase 1: Planning ==="
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 15 \
            --verbose \
            "$(cat /tmp/plan-prompt.txt)" 2>&1 | tee /tmp/phase1-output.txt

          # Verify plan was created
          if [ -f /tmp/plan.md ]; then
            echo "PLAN_CREATED=true" >> "$GITHUB_ENV"
            echo "=== Plan contents ==="
            cat /tmp/plan.md
          else
            echo "PLAN_CREATED=false" >> "$GITHUB_ENV"
            echo "Plan file not created — extracting from output"
            # Try to create a minimal plan from Claude's output
            echo "Auto-extracted plan from Claude output" > /tmp/plan.md
            tail -50 /tmp/phase1-output.txt >> /tmp/plan.md
          fi

      # ============================================================
      # PHASE 2: CODEX REVIEW (Codex 5.2 reviews the plan)
      # ============================================================

      - name: "Phase 2: Codex plan review"
        id: codex_plan
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          if [ ! -f /tmp/plan.md ]; then
            echo "No plan to review — skipping"
            echo "CODEX_REVIEW=" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "=== Phase 2: Codex reviewing plan ==="
          REVIEW=$(./codex-review.sh plan /tmp/plan.md 2>/dev/null || echo "Codex review unavailable")
          echo "$REVIEW" > /tmp/codex-plan-review.txt
          echo "CODEX_PLAN_REVIEW<<REVIEW_EOF" >> "$GITHUB_ENV"
          echo "$REVIEW" >> "$GITHUB_ENV"
          echo "REVIEW_EOF" >> "$GITHUB_ENV"

          echo "=== Codex review ==="
          echo "$REVIEW"

          # Send to Telegram
          if [ -f "./notify.sh" ]; then
            REVIEW_SHORT=$(echo "$REVIEW" | head -10)
            ./notify.sh codex_review "Plan review: $REVIEW_SHORT"
          fi

      # ============================================================
      # PHASE 3: IMPLEMENT (Claude implements with plan + review)
      # ============================================================

      - name: "Phase 3: Implement"
        id: implement
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ steps.dev.outputs.issue_title }}"
          BRANCH=$(git branch --show-current)

          PLAN=""
          if [ -f /tmp/plan.md ]; then
            PLAN=$(cat /tmp/plan.md)
          fi

          REVIEW=""
          if [ -f /tmp/codex-plan-review.txt ]; then
            REVIEW=$(cat /tmp/codex-plan-review.txt)
          fi

          cat > /tmp/implement-prompt.txt << PROMPT_EOF
          You are working in a GitHub repository on branch "${BRANCH}".

          TASK: Implement changes for Issue #${ISSUE_NUM}: "${ISSUE_TITLE}"

          YOUR PLAN (from Phase 1):
          ${PLAN}

          CODEX REVIEWER FEEDBACK (address any concerns):
          ${REVIEW}

          WORKFLOW:
          1. Read CLAUDE.md for project rules
          2. Implement the changes according to the plan
          3. Address the Codex reviewer's feedback
          4. ./notify.sh progress "Brief description of what was done"
          5. git add -A && git commit -m "feat: ${ISSUE_TITLE} (#${ISSUE_NUM})"
          6. git push origin ${BRANCH}

          RULES:
          - Stay on branch ${BRANCH}
          - Make clean, focused changes
          - Follow project conventions from CLAUDE.md
          - Once pushed, STOP — do not loop
          PROMPT_EOF

          echo "=== Phase 3: Implementing ==="
          set +e
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/implement-prompt.txt)" 2>&1 | tee /tmp/phase3-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "Reached max turns\|max.turns" /tmp/phase3-output.txt; then
            echo "IMPL_MAX_TURNS=true" >> "$GITHUB_ENV"
            exit 1
          fi
          exit $EXIT_CODE

      # Continue implementation if hit max turns
      - name: "Phase 3: Implement continue (+30)"
        id: impl_cont
        if: steps.implement.outcome == 'failure' && env.IMPL_MAX_TURNS == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          echo "=== Phase 3: Continuing implementation (+30 turns) ==="
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --continue \
            --max-turns 30 \
            --verbose

      # ============================================================
      # PHASE 4: CODE REVIEW (Codex reviews the diff)
      # ============================================================

      - name: "Phase 4: Codex code review"
        id: codex_code
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" = "$INITIAL_SHA" ]; then
            echo "No changes to review — skipping"
            echo "CODE_REVIEW_OK=true" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "=== Phase 4: Codex reviewing code ==="
          git diff "$INITIAL_SHA"..HEAD > /tmp/changes.diff

          REVIEW=$(./codex-review.sh code /tmp/changes.diff 2>/dev/null || echo "Codex review unavailable")
          echo "$REVIEW" > /tmp/codex-code-review.txt

          echo "=== Codex code review ==="
          echo "$REVIEW"

          # Send to Telegram
          if [ -f "./notify.sh" ]; then
            REVIEW_SHORT=$(echo "$REVIEW" | head -10)
            ./notify.sh codex_review "Code review: $REVIEW_SHORT"
          fi

          # Check if review found issues
          if echo "$REVIEW" | grep -qi "выглядит хорошо\|looks good\|no issues"; then
            echo "CODE_REVIEW_OK=true" >> "$GITHUB_ENV"
          else
            echo "CODE_REVIEW_OK=false" >> "$GITHUB_ENV"
          fi

      # Fix issues found by code review (one pass)
      - name: "Phase 4: Fix review issues"
        id: fix_review
        if: env.CODE_REVIEW_OK == 'false'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          BRANCH=$(git branch --show-current)
          ISSUE_NUM="${{ github.event.issue.number }}"

          REVIEW=""
          if [ -f /tmp/codex-code-review.txt ]; then
            REVIEW=$(cat /tmp/codex-code-review.txt)
          fi

          cat > /tmp/fix-prompt.txt << PROMPT_EOF
          You are working in a GitHub repository on branch "${BRANCH}".

          A code reviewer (Codex) found issues with your implementation for Issue #${ISSUE_NUM}.

          REVIEW FEEDBACK:
          ${REVIEW}

          INSTRUCTIONS:
          1. Fix the issues mentioned in the review
          2. Do NOT break existing functionality
          3. git add -A && git commit -m "fix: address code review feedback (#${ISSUE_NUM})"
          4. git push origin ${BRANCH}
          5. Once pushed, STOP
          PROMPT_EOF

          echo "=== Phase 4: Fixing review issues ==="
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 20 \
            --verbose \
            "$(cat /tmp/fix-prompt.txt)"

      # ============================================================
      # PHASE 5: SMOKE TESTS + PERFORMANCE
      # ============================================================

      - name: "Phase 5a: Run smoke tests"
        id: e2e_smoke
        continue-on-error: true
        env:
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" = "$INITIAL_SHA" ]; then
            echo "No changes — skipping tests"
            echo "SMOKE_OK=skip" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "=== Phase 5a: Smoke tests ==="
          npx playwright test smoke 2>&1 | tee /tmp/smoke-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if [ $EXIT_CODE -eq 0 ]; then
            echo "SMOKE_OK=true" >> "$GITHUB_ENV"
            [ -f "./notify.sh" ] && ./notify.sh test_pass "Smoke тесты пройдены"
          else
            echo "SMOKE_OK=false" >> "$GITHUB_ENV"
            FAILURES=$(grep -E "FAIL|Error|✘" /tmp/smoke-output.txt | head -5)
            [ -f "./notify.sh" ] && ./notify.sh test_fail "Smoke тесты упали: $FAILURES"
          fi
          exit 0

      - name: "Phase 5b: Run performance tests"
        id: e2e_perf
        continue-on-error: true
        env:
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" = "$INITIAL_SHA" ]; then
            echo "PERF_OK=skip" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "=== Phase 5b: Performance benchmarks ==="
          npx playwright test performance 2>&1 | tee /tmp/perf-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if [ $EXIT_CODE -eq 0 ]; then
            echo "PERF_OK=true" >> "$GITHUB_ENV"
            [ -f "./notify.sh" ] && ./notify.sh perf_pass "Все бенчмарки в бюджете"
          else
            echo "PERF_OK=false" >> "$GITHUB_ENV"
            FAILURES=$(grep -E "exceeds|below|grew" /tmp/perf-output.txt | head -5)
            [ -f "./notify.sh" ] && ./notify.sh perf_fail "Перфоманс регрессия: $FAILURES"
          fi
          exit 0

      # Auto-fix smoke failures
      - name: "Phase 5: Fix smoke test failures"
        id: fix_smoke
        if: env.SMOKE_OK == 'false'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          BRANCH=$(git branch --show-current)
          ISSUE_NUM="${{ github.event.issue.number }}"
          TEST_OUTPUT=$(cat /tmp/smoke-output.txt | tail -50)

          cat > /tmp/fix-smoke-prompt.txt << PROMPT_EOF
          You are working in a GitHub repository on branch "${BRANCH}".

          Playwright smoke tests FAILED after your implementation for Issue #${ISSUE_NUM}.

          TEST OUTPUT:
          ${TEST_OUTPUT}

          INSTRUCTIONS:
          1. Read the test failures carefully
          2. Fix the application code (NOT the tests) to make them pass
          3. Run: npx playwright test smoke — to verify fixes
          4. git add -A && git commit -m "fix: resolve smoke test failures (#${ISSUE_NUM})"
          5. git push origin ${BRANCH}
          6. Once pushed, STOP

          IMPORTANT: Fix the application code, not the test expectations.
          Only fix tests if they have genuine bugs (wrong selectors, etc.)
          PROMPT_EOF

          echo "=== Phase 5: Fixing smoke test failures ==="
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 20 \
            --verbose \
            "$(cat /tmp/fix-smoke-prompt.txt)"

      # Auto-fix performance regressions
      - name: "Phase 5: Fix performance regressions"
        id: fix_perf
        if: env.PERF_OK == 'false'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          BRANCH=$(git branch --show-current)
          ISSUE_NUM="${{ github.event.issue.number }}"
          PERF_OUTPUT=$(cat /tmp/perf-output.txt | tail -60)

          cat > /tmp/fix-perf-prompt.txt << PROMPT_EOF
          You are working in a GitHub repository on branch "${BRANCH}".

          Performance benchmarks FAILED after your implementation for Issue #${ISSUE_NUM}.
          Your changes caused a performance regression.

          FAILED BENCHMARKS:
          ${PERF_OUTPUT}

          PERFORMANCE BUDGETS (see tests/e2e/performance.spec.ts):
          - Page load (DOMContentLoaded): < 2s
          - Total page weight: < 500 KB
          - JS heap: < 30 MB (after 2s gameplay)
          - CLS: < 0.1
          - Input response: < 500ms
          - FPS: > 30 during gameplay
          - Memory leak: < 5 MB growth over 10s

          INSTRUCTIONS:
          1. Identify which performance budget was exceeded
          2. Optimize the code to fix the regression:
             - Reduce file sizes (minify, remove unused code/assets)
             - Fix memory leaks (clean up event listeners, timers, closures)
             - Reduce layout thrashing (batch DOM reads/writes)
             - Optimize canvas rendering (reduce draw calls, cache)
             - Remove unnecessary network requests
          3. Run: npx playwright test performance — to verify fixes
          4. git add -A && git commit -m "perf: fix performance regression (#${ISSUE_NUM})"
          5. git push origin ${BRANCH}
          6. Once pushed, STOP

          IMPORTANT: Optimize the code, do NOT relax the budget thresholds.
          PROMPT_EOF

          echo "=== Phase 5: Fixing performance regressions ==="
          claude -p --dangerously-skip-permissions \
            --model claude-opus-4-6 \
            --max-turns 25 \
            --verbose \
            "$(cat /tmp/fix-perf-prompt.txt)"

      # ============================================================
      # SONNET FALLBACK (if all Opus attempts failed)
      # ============================================================

      - name: Check if Opus succeeded
        if: always()
        id: opus_result
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "$INITIAL_SHA" ]; then
            echo "ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Reset for Sonnet
        if: steps.opus_result.outputs.ok == 'false'
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      - name: "Notify: switching to Sonnet"
        if: steps.opus_result.outputs.ok == 'false' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"opus_unavailable\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: "Claude Code — Sonnet (fallback)"
        id: sonnet
        if: steps.opus_result.outputs.ok == 'false'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ steps.dev.outputs.issue_title }}"
          BRANCH=$(git branch --show-current)

          cat > /tmp/sonnet-prompt.txt << PROMPT_EOF
          You are working in a GitHub repository on branch "${BRANCH}".

          TASK: Implement changes for Issue #${ISSUE_NUM}: "${ISSUE_TITLE}"

          WORKFLOW:
          1. ./notify.sh plan "Your plan"
          2. Read CLAUDE.md for project rules
          3. Implement changes
          4. git add -A && git commit -m "feat: ${ISSUE_TITLE} (#${ISSUE_NUM})"
          5. git push origin ${BRANCH}

          RULES:
          - Stay on branch ${BRANCH}
          - Make clean, focused changes
          - Once pushed, STOP
          PROMPT_EOF

          set +e
          claude -p --dangerously-skip-permissions \
            --model claude-sonnet-4-5-20250929 \
            --max-turns 50 \
            --verbose \
            "$(cat /tmp/sonnet-prompt.txt)" 2>&1 | tee /tmp/sonnet-output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if grep -qi "Reached max turns\|max.turns" /tmp/sonnet-output.txt; then
            echo "SONNET_MAX_TURNS=true" >> "$GITHUB_ENV"
            exit 1
          fi
          exit $EXIT_CODE

      - name: "Claude Code — Sonnet continue (+30)"
        if: steps.sonnet.outcome == 'failure' && env.SONNET_MAX_TURNS == 'true'
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          claude -p --dangerously-skip-permissions \
            --model claude-sonnet-4-5-20250929 \
            --continue \
            --max-turns 30 \
            --verbose

      # ============================================================
      # VERIFY & FINALIZE
      # ============================================================

      - name: Verify actual push
        if: always()
        id: verify
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "Initial SHA: $INITIAL_SHA"
          echo "Current SHA: $CURRENT_SHA"

          if [[ "$CURRENT_SHA" != "$INITIAL_SHA" ]]; then
            echo "New local commits detected"
            git log --oneline "$INITIAL_SHA"..HEAD
            echo "pushed=true" >> "$GITHUB_OUTPUT"
            echo "commit_sha=$CURRENT_SHA" >> "$GITHUB_OUTPUT"
            echo "commit_sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          else
            git fetch origin
            BRANCH=$(git branch --show-current)
            REMOTE_SHA=$(git rev-parse "origin/$BRANCH" 2>/dev/null || echo "none")
            if [[ "$REMOTE_SHA" != "$INITIAL_SHA" ]] && [[ "$REMOTE_SHA" != "none" ]]; then
              echo "Remote has new commits"
              echo "pushed=true" >> "$GITHUB_OUTPUT"
              echo "commit_sha=$REMOTE_SHA" >> "$GITHUB_OUTPUT"
              echo "commit_sha_short=$(git rev-parse --short $REMOTE_SHA)" >> "$GITHUB_OUTPUT"
            else
              echo "No new commits"
              echo "pushed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Update DEVLOG.md
        if: always() && steps.verify.outputs.pushed == 'true'
        continue-on-error: true
        run: |
          BRANCH=$(git branch --show-current)
          COMMIT_SHA="${{ steps.verify.outputs.commit_sha }}"
          COMMIT_SHORT="${{ steps.verify.outputs.commit_sha_short }}"
          ISSUE_NUM="${{ steps.dev.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.dev.outputs.issue_title }}"
          TODAY=$(date +%Y-%m-%d)

          CHANGED_FILES=$(git diff --name-only "$INITIAL_SHA".."$COMMIT_SHA" 2>/dev/null | grep -v "DEVLOG.md" || echo "")

          FILES_LIST=""
          while IFS= read -r file; do
            [ -n "$file" ] && FILES_LIST="${FILES_LIST}- \`${file}\`
          "
          done <<< "$CHANGED_FILES"

          if [ ! -f "DEVLOG.md" ]; then
            printf "# Development Log\n\nИстория изменений для cherry-pick в main.\n\n" > DEVLOG.md
          fi

          ENTRY="## #${ISSUE_NUM} — ${ISSUE_TITLE}
          **Дата:** ${TODAY}
          **Ветка:** ${BRANCH}
          **Коммит:** \`${COMMIT_SHORT}\`
          **Статус:** ✅ готово к переносу

          ### Изменённые файлы
          ${FILES_LIST}
          ### Как перенести в main
          \`\`\`bash
          git cherry-pick ${COMMIT_SHA}
          \`\`\`

          ---

          "

          head -4 DEVLOG.md > DEVLOG_new.md
          echo "$ENTRY" >> DEVLOG_new.md
          tail -n +5 DEVLOG.md >> DEVLOG_new.md
          mv DEVLOG_new.md DEVLOG.md

          git add DEVLOG.md
          git commit -m "docs: update DEVLOG for #${ISSUE_NUM}" || true
          git push origin "$BRANCH" || true

      # ============================================================
      # NOTIFICATIONS
      # ============================================================

      - name: "Notify: all failed"
        if: always() && steps.verify.outputs.pushed != 'true' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_failed\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: "Notify: changes pushed"
        if: always() && steps.verify.outputs.pushed == 'true' && steps.dev.outputs.branch != ''
        continue-on-error: true
        env:
          ISSUE_NUMBER: ${{ steps.dev.outputs.issue_number }}
          BOT_NOTIFY_URL: ${{ secrets.BOT_WEBHOOK_URL }}
          GITHUB_HEAD_REF: ${{ steps.dev.outputs.branch }}
        run: |
          # Report test results in notification
          TEST_STATUS=""
          if [ "$SMOKE_OK" = "true" ]; then
            TEST_STATUS="Smoke: PASSED"
          elif [ "$SMOKE_OK" = "false" ]; then
            TEST_STATUS="Smoke: FAILED (auto-fix attempted)"
          else
            TEST_STATUS="Smoke: skipped"
          fi

          if [ "$PERF_OK" = "true" ]; then
            TEST_STATUS="$TEST_STATUS | Perf: PASSED"
          elif [ "$PERF_OK" = "false" ]; then
            TEST_STATUS="$TEST_STATUS | Perf: REGRESSION (auto-fix attempted)"
          else
            TEST_STATUS="$TEST_STATUS | Perf: skipped"
          fi

          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"merged\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

          # Send test status via notify.sh
          if [ -f "./notify.sh" ]; then
            ./notify.sh done "$TEST_STATUS. Task complete."
          fi

      - name: Close issue
        if: always() && steps.verify.outputs.pushed == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = context.payload.issue?.number;
            if (issueNum) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                state: 'closed'
              });
            }
