name: Claude Code

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ dev-Ð²ÐµÑ‚ÐºÑƒ Ð¸Ð· Ð»ÐµÐ¹Ð±Ð»Ð°
      - name: Detect developer branch
        id: dev
        uses: actions/github-script@v7
        with:
          script: |
            let labels = [];
            let issueTitle = '';
            let issueNumber = '';
            if (context.payload.issue) {
              labels = context.payload.issue.labels.map(l => l.name);
              issueTitle = context.payload.issue.title;
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              labels = context.payload.pull_request.labels.map(l => l.name);
              issueTitle = context.payload.pull_request.title;
              issueNumber = context.payload.pull_request.number;
            }

            const devLabel = labels.find(l => l.startsWith('developer:'));
            let branch = '';
            let devName = '';
            if (devLabel) {
              devName = devLabel.replace('developer:', '');
              branch = `dev/${devName}`;
            }

            core.setOutput('branch', branch);
            core.setOutput('dev_name', devName);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_number', String(issueNumber));
            console.log(`Developer: ${devName || '(none)'}`);
            console.log(`Target branch: ${branch || 'main (default)'}`);

      # 2. Checkout Ð½Ð° dev-Ð²ÐµÑ‚ÐºÑƒ
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.dev.outputs.branch || 'main' }}

      # 3. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ dev-Ð²ÐµÑ‚ÐºÑƒ Ð¸Ð· main ÐµÑÐ»Ð¸ ÐµÑ‘ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
      - name: Ensure dev branch exists
        if: steps.dev.outputs.branch != ''
        run: |
          BRANCH="${{ steps.dev.outputs.branch }}"
          if git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "âœ… Branch $BRANCH already exists"
          else
            echo "ðŸŒ± Creating $BRANCH from main"
            git checkout -b "$BRANCH" origin/main
            git push origin "$BRANCH"
            echo "âœ… Branch $BRANCH created"
          fi

      # 4. ðŸ”” Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ: Claude Ð½Ð°Ñ‡Ð°Ð» Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ
      - name: Notify â€” Claude started
        if: steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_started\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # 5. ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git
      - name: Configure git
        run: |
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      # 6. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Claude Code CLI (Ð¼Ð¸Ð½ÑƒÑ ÑÐ»Ð¾Ð¼Ð°Ð½Ð½Ñ‹Ð¹ SDK)
      - name: Install Claude Code CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "âœ… Claude Code CLI installed"
          $HOME/.local/bin/claude --version

      # 7. Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð¸Ð· issue
      - name: Prepare prompt
        id: prompt
        shell: bash
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE=$(echo "${{ steps.dev.outputs.issue_title }}" | sed 's/"/\\"/g')
          BRANCH=$(git branch --show-current)

          cat > /tmp/claude-prompt.txt << EOF
          You are working in a GitHub repository checkout on branch "${BRANCH}".

          TASK: Implement changes for Issue #${ISSUE_NUM}: "${ISSUE_TITLE}"

          Steps:
          1. Read CLAUDE.md in repo root if it exists
          2. Look at relevant source files
          3. Implement the requested changes
          4. Stage all changes: git add -A
          5. Commit: git commit -m "feat: ${ISSUE_TITLE} (#${ISSUE_NUM})"
          6. Push: git push origin ${BRANCH}

          Rules:
          - Stay on current branch (${BRANCH}), do NOT create new branches
          - Make clean, focused changes
          - Always commit and push when done
          EOF

          echo "âœ… Prompt ready for issue #${ISSUE_NUM} on branch ${BRANCH}"

      # ============ OPUS: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° 1 ============
      - name: "Claude Code â€” Opus (attempt 1)"
        id: opus1
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ§  Running Claude Code (Opus, attempt 1)..."
          claude -p \
            --model claude-opus-4-5-20251101 \
            --max-turns 30 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)"

      - name: Reset after Opus 1
        if: steps.opus1.outcome == 'failure'
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      # ============ OPUS: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° 2 ============
      - name: "Claude Code â€” Opus (attempt 2)"
        id: opus2
        if: steps.opus1.outcome == 'failure'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ§  Running Claude Code (Opus, attempt 2)..."
          claude -p \
            --model claude-opus-4-5-20251101 \
            --max-turns 30 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)"

      - name: Reset after Opus 2
        if: steps.opus1.outcome == 'failure' && steps.opus2.outcome == 'failure'
        run: |
          git checkout -- . 2>/dev/null || true
          git clean -fd 2>/dev/null || true

      # ============ SONNET: fallback ============
      - name: Notify â€” switching to Sonnet
        if: steps.opus1.outcome == 'failure' && steps.opus2.outcome == 'failure' && steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"opus_unavailable\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: "Claude Code â€” Sonnet (fallback)"
        id: sonnet
        if: steps.opus1.outcome == 'failure' && steps.opus2.outcome == 'failure'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ§  Running Claude Code (Sonnet, fallback)..."
          claude -p \
            --model claude-sonnet-4-5-20250929 \
            --max-turns 30 \
            --verbose \
            "$(cat /tmp/claude-prompt.txt)"

      # ============ FAIL ============
      - name: Notify â€” all attempts failed
        if: |
          steps.opus1.outcome == 'failure' &&
          steps.opus2.outcome == 'failure' &&
          steps.sonnet.outcome == 'failure' &&
          steps.dev.outputs.branch != ''
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"claude_failed\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      # ============ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ + Ð£Ð’Ð•Ð”ÐžÐœÐ›Ð•ÐÐ˜Ð• ============
      - name: Check results
        id: check
        run: |
          if [[ "${{ steps.opus1.outcome }}" == "success" ]] || \
             [[ "${{ steps.opus2.outcome }}" == "success" ]] || \
             [[ "${{ steps.sonnet.outcome }}" == "success" ]]; then
            echo "claude_ok=true" >> "$GITHUB_OUTPUT"
          else
            echo "claude_ok=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify â€” changes pushed
        if: steps.dev.outputs.branch != '' && steps.check.outputs.claude_ok == 'true'
        continue-on-error: true
        run: |
          curl -s -X POST "${{ secrets.BOT_WEBHOOK_URL }}/github/notify" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"merged\",\"branch\":\"${{ steps.dev.outputs.branch }}\",\"issue_number\":\"${{ steps.dev.outputs.issue_number }}\",\"issue_title\":\"${{ steps.dev.outputs.issue_title }}\"}"

      - name: Close issue
        if: steps.check.outputs.claude_ok == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const issueNum = context.payload.issue?.number;
            if (issueNum) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNum,
                state: 'closed'
              });
              console.log(`âœ… Closed issue #${issueNum}`);
            }
